<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Product - Admin Panel</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÑ</text></svg>">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" th:href="@{/css/product-styles.css}">
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin/v1/category">Admin Panel</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/admin/v1/category">Categories</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" aria-current="page" href="#" id="navbarDropdownProducts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Products
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownProducts">
              <li><a class="dropdown-item" href="/admin/v1/create">Create Product</a></li>
              <li><a class="dropdown-item" href="/admin/v1/update">Update Product</a></li>
              <li><a class="dropdown-item" href="/admin/v1/delete">Delete Product</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/admin/v1/list-products">List Products</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Users</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<main class="main-content">
  <div class="container">
    <h1 class="mb-5 text-center text-warning">Update Product</h1>

    <div class="form-section">
      <h2 class="text-warning">Product Details for Update</h2>

      <div th:if="${errorMessage}" class="error-message alert alert-danger" role="alert">
        <p th:text="${errorMessage}"></p>
      </div>

      <form id="updateProductForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="productId" class="form-label">Product ID (to find and update):</label>
          <input type="number" class="form-control" id="productId" name="id" required placeholder="Enter existing product ID" min="1">
          <div class="form-text text-muted">–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π ID –ø—Ä–æ–¥—É–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å.</div>
        </div>

        <div class="mb-3">
          <label for="newProductName" class="form-label">New Product Name (optional):</label>
          <input type="text" class="form-control" id="newProductName" name="newName" placeholder="Enter new product name">
          <div class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞.</div>
        </div>

        <div class="mb-3">
          <label for="newDescription" class="form-label">New Description (optional):</label>
          <textarea class="form-control" id="newDescription" name="description" rows="5" placeholder="Enter new description"></textarea>
        </div>
        <div class="mb-3">
          <label for="newPrice" class="form-label">New Price (optional):</label>
          <input type="number" class="form-control" id="newPrice" name="price" step="0.01" min="0" placeholder="Enter new price">
        </div>
        <div class="mb-3">
          <label for="newQuantity" class="form-label">New Quantity (optional):</label>
          <input type="number" class="form-control" id="newQuantity" name="quantity" min="0" placeholder="Enter new quantity">
        </div>

        <div class="mb-3">
          <label for="newProductImageFile" class="form-label">New Product Image (optional):</label>
          <input type="file" class="form-control" id="newProductImageFile" name="imageFile"> <div class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏. –≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</div>
        </div>

        <div class="mb-3">
          <label for="newCategoryNames" class="form-label">New Category Names (comma-separated, optional):</label>
          <input type="text" class="form-control" id="newCategoryNames" name="categoryNames" placeholder="e.g., UpdatedCategory, AnotherOne">
          <div class="form-text text-muted">–†–∞–∑–¥–µ–ª—è–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–ø—è—Ç—ã–º–∏. –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ, —ç—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</div>
        </div>
        <button type="submit" class="btn btn-warning w-100">Update Product</button>
      </form>
      <div id="updateProductResponse" class="response-area mt-3 d-none"></div>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container">
    <p>&copy; 2025 Your Company. All rights reserved.</p>
    <p>Admin Panel v1.0</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
  /**
   * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.
   * @param {string} elementId - ID DOM-—ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞.
   * @param {object} response - –û–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π ok, status, statusText, data.
   */
  function displayResponse(elementId, response) {
    const responseDiv = document.getElementById(elementId);
    responseDiv.classList.remove('success', 'error', 'd-none');

    let contentToDisplay = response.data;

    if (response.ok) {
      responseDiv.classList.add('success');
      try {
        const parsedData = JSON.parse(response.data);
        contentToDisplay = JSON.stringify(parsedData, null, 2);
      } catch (e) {
        console.warn(`–û—Ç–≤–µ—Ç –¥–ª—è ${elementId} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç.`);
      }
      responseDiv.innerHTML = `<p class="fw-bold mb-1">–£—Å–ø–µ—Ö! HTTP ${response.status}</p><pre>${contentToDisplay || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.'}</pre>`;
    } else {
      responseDiv.classList.add('error');
      try {
        const parsedError = JSON.parse(response.data);
        contentToDisplay = JSON.stringify(parsedError, null, 2);
      } catch (e) {
        console.warn(`–û—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ –¥–ª—è ${elementId} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç.`);
      }
      responseDiv.innerHTML = `<p class="fw-bold mb-1">–û—à–∏–±–∫–∞: HTTP ${response.status} ${response.statusText}</p><pre>${contentToDisplay || '–ù–µ—Ç —Ç–µ–ª–∞ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}</pre>`;
    }

    responseDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // –û–ë–†–ê–ë–û–¢–ö–ê –§–û–†–ú–´ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–†–û–î–£–ö–¢–ê
  document.getElementById('updateProductForm').addEventListener('submit', async function(event) {
    event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

    const productId = document.getElementById('productId').value.trim();
    const newProductName = document.getElementById('newProductName').value.trim();
    const newDescription = document.getElementById('newDescription').value.trim();
    const newPrice = document.getElementById('newPrice').value.trim();
    const newQuantity = document.getElementById('newQuantity').value.trim();
    const newProductImageFile = document.getElementById('newProductImageFile').files[0];
    const newCategoryNamesInput = document.getElementById('newCategoryNames').value.trim();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –ø—Ä–æ–¥—É–∫—Ç–∞ –≤–≤–µ–¥–µ–Ω –∏ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º
    if (!productId || isNaN(productId) || parseInt(productId) <= 0) {
      displayResponse('updateProductResponse', {
        ok: false, status: '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', statusText: '–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø—Ä–æ–¥—É–∫—Ç–∞',
        data: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π ID –ø—Ä–æ–¥—É–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å.'
      });
      return;
    }

    const formData = new FormData();
    formData.append('id', productId);

    if (newProductName) formData.append('newName', newProductName);
    if (newDescription) formData.append('description', newDescription);
    if (newPrice) formData.append('price', newPrice);
    if (newQuantity) formData.append('quantity', newQuantity);
    if (newProductImageFile) {
      formData.append('imageFile', newProductImageFile);
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø categoryNames
    if (newCategoryNamesInput) {
      const categoryNamesArray = newCategoryNamesInput.split(',')
              .map(name => name.trim())
              .filter(name => name !== ''); // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏

      categoryNamesArray.forEach(name => {
        formData.append('categoryNames', name);
      });
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª–µ categoryNamesInput –ø—É—Å—Ç–æ–µ, –Ω–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —è–≤–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ,
      // –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É. –í –≤–∞—à–µ–π Java-–ª–æ–≥–∏–∫–µ, –µ—Å–ª–∏ getCategoryNames() –Ω–µ null,
      // –Ω–æ getCategoryNames().isEmpty() == true, —Ç–æ categories.removeAll(categories) –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è.
      // –ß—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ, –≤–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ ProductUpdateDto.categoryNames
      // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º Set, –∞ –Ω–µ null.
      // –ï—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –ø—É—Å—Ç–æ–º –≤–≤–æ–¥–µ, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –ø—É—Å—Ç—ã–º.
      // –¢–µ–∫—É—â–∞—è Java-–ª–æ–≥–∏–∫–∞ (if (productUpdateDto.getCategoryNames()!=null && !productUpdateDto.getCategoryNames().isEmpty()))
      // –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ categoryNames –Ω–µ –ø—Ä–∏—Å–ª–∞–Ω –∏–ª–∏ –ø—É—Å—Ç, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è.
      // –ß—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –≤–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã Set<Category> –±—ã–ª –ø—É—Å—Ç—ã–º, –Ω–æ –Ω–µ null.
      // –ï—Å–ª–∏ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É: formData.append('categoryNames', '');
      // —Ç–æ –≤ Java –≤—ã –ø–æ–ª—É—á–∏—Ç–µ Set —Å –æ–¥–Ω–æ–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, —á—Ç–æ –Ω–µ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ.
      // –õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ - —ç—Ç–æ –ª–∏–±–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥, –ª–∏–±–æ —É–±–µ–¥–∏—Ç—å—Å—è,
      // —á—Ç–æ –≤–∞—à DTO –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Set<String> –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —Å –ø—É—Å—Ç—ã–º Set.
      // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–∫, —á—Ç–æ –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è.
    }

    const url = '/product/v1/admin/update';

    try {
      const res = await fetch(url, {
        method: 'PUT',
        body: formData,
      });
      const responseData = await res.text();

      displayResponse('updateProductResponse', {
        ok: res.ok,
        status: res.status,
        statusText: res.statusText,
        data: responseData
      });

      if (res.ok) {
        this.reset(); // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      }
    } catch (error) {
      displayResponse('updateProductResponse', {
        ok: false,
        status: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞',
        statusText: error.message,
        data: `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞.`
      });
    }
  });
</script>
</body>
</html>