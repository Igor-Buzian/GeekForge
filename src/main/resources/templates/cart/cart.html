<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body { font-family: Arial, sans-serif; }
    .container { max-width: 900px; margin: auto; }
    .main-content { padding-top: 70px; padding-bottom: 50px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: middle; }
    th { background-color: #e9ecef; }
    .cart-summary {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      background-color: #f8f9fa;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .cart-summary h2 {
      color: #007bff;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .cart-summary p {
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .cart-summary p span {
      font-weight: bold;
      color: #343a40;
    }
    .cart-item-image {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 5px;
      vertical-align: middle;
    }
    .update-quantity-form {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .update-quantity-form input[type="number"] {
      width: 70px;
      text-align: center;
    }
    .loading {
      display: none;
      margin-left: 10px;
      color: #0d6efd;
    }
    .empty-cart-message {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #6c757d;
      background-color: #e9ecef;
      border-radius: 8px;
      margin-top: 30px;
    }
    .alert {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 5px;
      font-weight: bold;
    }
    .alert.success {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .alert.danger {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .cart-counter {
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75em;
      vertical-align: super;
      margin-left: -8px; /* –ù–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –≤–ª–µ–≤–æ –¥–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è */
    }
  </style>
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/api/v1/user/all-products">–ù–∞—à –ú–∞–≥–∞–∑–∏–Ω</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/api/v1/user/all-products">–¢–æ–≤–∞—Ä—ã</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/cart">
              –ö–æ—Ä–∑–∏–Ω–∞ <span id="cartItemCount" class="cart-counter d-none">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/my-orders">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/login">–í–æ–π—Ç–∏</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/auth/v1/logout">–í—ã–π—Ç–∏</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<main class="main-content">
  <div class="container mt-5 pt-3">
    <h1 class="mb-4 text-center text-primary">–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</h1>

    <div id="alert-message" class="mb-3" style="display: none;"></div>

    <div class="cart-summary" th:if="${cartSummary != null}">
      <h2>–°–≤–æ–¥–∫–∞ –ø–æ –ö–æ—Ä–∑–∏–Ω–µ</h2>
      <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤: <span id="total-quantity" th:text="${cartSummary.totalQuantity}">0</span></p>
      <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="total-cost" th:text="${#numbers.formatDecimal(cartSummary.totalCost, 0, 'COMMA', 2, 'POINT')}">0.00</span> MDL</p>
      <div class="mt-3">
        <a href="/checkout" class="btn btn-success btn-lg">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞</a>
      </div>
    </div>

    <hr class="my-4"/>

    <div id="cart-items-container">
      <div th:if="${cartItemsPage.content.isEmpty()}" id="empty-cart-message" class="empty-cart-message">
        <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</p>
      </div>

      <div th:unless="${cartItemsPage.content.isEmpty()}" id="actual-cart-table-wrapper">
        <table class="table table-hover align-middle">
          <thead>
          <tr>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th>–°—É–º–º–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
          </thead>
          <tbody id="cart-table-body">
          <tr th:each="item : ${cartItemsPage.content}" th:id="'cart-item-' + ${item.productId}">
            <td th:text="${item.productName}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</td>
            <td>
              <img th:if="${item.productImage != null and item.productImage.length() > 0}"
                   th:src="${item.productImage}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="cart-item-image"/>
              <span th:unless="${item.productImage != null and item.productImage.length() > 0}">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
            </td>
            <td th:text="${#numbers.formatDecimal(item.productPrice, 0, 'COMMA', 2, 'POINT')}">10.00 MDL</td>
            <td>
              <form class="update-quantity-form" th:data-product-id="${item.productId}" onsubmit="updateCartItem(event)">
                <input type="number" name="quantity" th:value="${item.quantity}" min="0" class="form-control"/>
                <button type="submit" class="btn btn-warning btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <span class="loading spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </form>
            </td>
            <td class="item-total" th:text="${#numbers.formatDecimal(item.itemTotal, 0, 'COMMA', 2, 'POINT')}">20.00 MDL</td>
            <td>
              <form class="remove-item-form" th:data-product-id="${item.productId}" onsubmit="removeCartItem(event)">
                <button type="submit" class="btn btn-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
                <span class="loading spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </form>
            </td>
          </tr>
          </tbody>
        </table>

        <nav aria-label="Cart Page Navigation" class="mt-4">
          <ul class="pagination justify-content-center" id="paginationControls">
            <li class="page-item" th:classappend="${cartItemsPage.hasPrevious() ? '' : 'disabled'}">
              <a class="page-link" href="#" onclick="changePage(event, -1)">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, cartItemsPage.totalPages - 1)}"
                th:classappend="${i eq cartItemsPage.number ? 'active' : ''}">
              <a class="page-link" href="#" th:text="${i + 1}" onclick="changePage(event, this.textContent - 1)">1</a>
            </li>
            <li class="page-item" th:classappend="${cartItemsPage.hasNext() ? '' : 'disabled'}">
              <a class="page-link" href="#" onclick="changePage(event, 1)">–°–ª–µ–¥—É—é—â–∞—è</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

  </div>
</main>

<footer class="footer mt-5 py-3 bg-light">
  <div class="container text-center">
    <p>&copy; 2025 –í–∞—à –ú–∞–≥–∞–∑–∏–Ω. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</footer>

<script th:inline="javascript">
  /*<![CDATA[*/
  // Utility function to show alert messages
  function showAlert(message, type) {
    const alertBox = document.getElementById('alert-message');
    alertBox.textContent = message;
    alertBox.className = `alert ${type}`;
    alertBox.style.display = 'block';
    setTimeout(() => {
      alertBox.style.display = 'none';
    }, 5000);
  }

  // Helper function to format numbers
  function formatDecimal(number) {
    if (typeof number !== 'number') return '0.00';
    return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // --- Start of updateCartItem function ---
  async function updateCartItem(event) {
    event.preventDefault(); // Prevent default form submission
    const form = event.target;
    const productId = form.getAttribute('data-product-id');
    const quantityInput = form.querySelector('input[name="quantity"]');
    const quantity = parseInt(quantityInput.value); // Ensure quantity is an integer
    const button = form.querySelector('button');
    const loading = form.querySelector('.loading');

    // Basic validation for quantity
    if (isNaN(quantity) || quantity < 0) {
      showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏ –Ω–µ –º–µ–Ω—å—à–µ 0.', 'danger');
      return;
    }

    button.disabled = true; // Disable button during request
    loading.style.display = 'inline'; // Show loading indicator

    try {
      // The `fetch` API returns a Promise that resolves with the `Response` object
      const response = await fetch('/api/v1/cart/update-quantity', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          // Assuming JWT is handled via Auth_cookie by the browser for this origin
          // If you need to manually send it in Authorization header, uncomment below:
          // 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
        },
        body: JSON.stringify({
          productId: parseInt(productId),
          quantity: quantity
        })
      });

      // Check if the response was successful (status 200-299)
      if (response.ok) {
        // Parse the JSON response body
        const updatedCart = await response.json();
        showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');

        // --- DYNAMIC UI UPDATE ---
        // 1. Update Cart Summary
        document.getElementById('total-quantity').textContent = updatedCart.totalQuantity;
        document.getElementById('total-cost').textContent = formatDecimal(updatedCart.totalCost);

        // 2. Update the specific item row in the table
        const row = document.getElementById('cart-item-' + productId);
        const updatedItem = updatedCart.cartItems.find(item => item.productId == productId); // Find the updated item

        if (updatedItem && row) {
          quantityInput.value = updatedItem.quantity; // Update quantity input field
          row.querySelector('.item-total').textContent = formatDecimal(updatedItem.itemTotal); // Update item total
        }

        // Handle case where quantity becomes 0 (item is conceptually removed)
        if (updatedItem && updatedItem.quantity === 0 || !updatedItem) {
          if (row) row.remove(); // Remove the row from the table
        }

        // Check if cart is now empty
        if (updatedCart.totalQuantity === 0) {
          const table = document.getElementById('cart-table');
          if (table) table.remove(); // Remove the whole table
          const emptyMessage = document.getElementById('empty-cart-message');
          if (!emptyMessage) { // Add empty message if not already present
            document.getElementById('cart-items-container').innerHTML = '<div id="empty-cart-message"><p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</p></div>';
          }
        }

      } else {
        // Handle server errors (e.g., 4xx, 5xx)
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ${errorData.message || response.statusText}`, 'danger');
        // Restore original quantity if update failed (optional)
        // quantityInput.value = initialQuantity; // You'd need to store initial quantity
      }
    } catch (error) {
      // Handle network errors (e.g., no internet connection)
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.', 'danger');
      console.error('Error:', error);
    } finally {
      button.disabled = false; // Re-enable button
      loading.style.display = 'none'; // Hide loading indicator
    }
  }
  // --- End of updateCartItem function ---

  // --- Start of removeCartItem function ---
  async function removeCartItem(event) {
    event.preventDefault(); // Prevent default form submission
    const form = event.target;
    const productId = form.getAttribute('data-product-id');
    const button = form.querySelector('button');
    const loading = form.querySelector('.loading');

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
      return; // User cancelled
    }

    button.disabled = true; // Disable button
    loading.style.display = 'inline'; // Show loading indicator

    try {
      const response = await fetch(`/api/v1/cart/remove/${productId}`, {
        method: 'DELETE', // HTTP DELETE method
        headers: {
          'Accept': 'application/json',
          // Assuming JWT is handled via Auth_cookie
          // 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
        }
      });

      if (response.ok) {
        const updatedCart = await response.json(); // Get updated cart summary
        showAlert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã!', 'success');

        // --- DYNAMIC UI UPDATE ---
        // 1. Remove the item row from the table
        const row = document.getElementById('cart-item-' + productId);
        if (row) row.remove();

        // 2. Update Cart Summary
        document.getElementById('total-quantity').textContent = updatedCart.totalQuantity;
        document.getElementById('total-cost').textContent = formatDecimal(updatedCart.totalCost);

        // 3. Check if cart is now empty
        if (updatedCart.totalQuantity === 0) {
          const table = document.getElementById('cart-table');
          if (table) table.remove();
          const emptyMessage = document.getElementById('empty-cart-message');
          if (!emptyMessage) {
            document.getElementById('cart-items-container').innerHTML = '<div id="empty-cart-message"><p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</p></div>';
          }
        }

      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ${errorData.message || response.statusText}`, 'danger');
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.', 'danger');
      console.error('Error:', error);
    } finally {
      button.disabled = false; // Re-enable button
      loading.style.display = 'none'; // Hide loading indicator
    }
  }
  // --- End of removeCartItem function ---

  /*]]>*/
</script>
</body>
</html>