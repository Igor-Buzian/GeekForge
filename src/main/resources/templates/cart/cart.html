<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf}" />
  <link rel="stylesheet" th:href="@{/css/busket.css}">
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/api/v1/user/all-products">–ù–∞—à –ú–∞–≥–∞–∑–∏–Ω</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/api/v1/user/all-products">–¢–æ–≤–∞—Ä—ã</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/cart">
              –ö–æ—Ä–∑–∏–Ω–∞ <span id="cartItemCount" class="cart-counter d-none">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/my-orders">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/login">–í–æ–π—Ç–∏</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/auth/v1/logout">–í—ã–π—Ç–∏</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<main class="main-content">
  <div class="container mt-5 pt-3">
    <h1 class="mb-4 text-center text-primary">–í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞</h1>

    <div id="alert-message" class="mb-3" style="display: none;"></div>

    <div class="cart-summary">
      <h2>–°–≤–æ–¥–∫–∞ –ø–æ –í—ã–±—Ä–∞–Ω–Ω—ã–º –¢–æ–≤–∞—Ä–∞–º</h2>
      <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: <span id="selected-total-quantity">0</span></p>
      <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: <span id="selected-total-cost">0.00</span> MDL</p>
      <div class="mt-3">
        <button type="button" id="purchaseSelectedButton" class="btn btn-success btn-lg disabled" onclick="purchaseSelectedItems()">
          –ö—É–ø–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
        </button>
      </div>
    </div>

    <hr class="my-4"/>

    <div id="cart-items-container">
      <div th:if="${cartItemsPage.content.isEmpty()}" id="empty-cart-message" class="empty-cart-message" style="display: block;">
        <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</p>
      </div>

      <div th:unless="${cartItemsPage.content.isEmpty()}" id="actual-cart-table-wrapper" style="display: block;">
        <table class="table table-hover align-middle">
          <thead>
          <tr>
            <th>
              <input type="checkbox" id="selectAllItemsCheckbox" onclick="toggleSelectAll(this)"/>
            </th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th>–°—É–º–º–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
          </thead>
          <tbody id="cart-table-body">
          </tbody>
        </table>

        <nav aria-label="Cart Page Navigation" class="mt-4">
          <ul class="pagination justify-content-center" id="paginationControls">
          </ul>
        </nav>
      </div>
    </div>

  </div>
</main>

<footer class="footer mt-5 py-3 bg-light">
  <div class="container text-center">
    <p>&copy; 2025 –í–∞—à –ú–∞–≥–∞–∑–∏–Ω. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  // Utility function to show alert messages
  function showAlert(message, type) {
    const alertBox = document.getElementById('alert-message');
    if (alertBox) { // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null
      alertBox.textContent = message;
      alertBox.className = `alert alert-${type}`; // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ Bootstrap –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 5000);
    }
  }

  // Helper function to format numbers
  function formatDecimal(number) {
    if (typeof number !== 'number') return '0.00';
    return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // --- Get CSRF Token and Header Name ---
  const csrfToken = document.querySelector("meta[name='_csrf']") ? document.querySelector("meta[name='_csrf']").getAttribute("content") : null;
  const csrfHeader = document.querySelector("meta[name='_csrf_header']") ? document.querySelector("meta[name='_csrf_header']").getAttribute("content") : null;

  function getHeaders() {
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    };
    if (csrfToken && csrfHeader) {
      headers[csrfHeader] = csrfToken;
    }
    return headers;
  }

  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã
  let currentCartItems = [];
  let currentPage = /*[[${cartItemsPage.number}]]*/ 0;
  let totalPages = /*[[${cartItemsPage.totalPages}]]*/ 0;
  const pageSize = /*[[${cartItemsPage.size}]]*/ 10; // –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ Thymeleaf

  document.addEventListener('DOMContentLoaded', function() {
    updateCartItemCount();
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º currentCartItems –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –í–∞–∂–Ω–æ: Thymeleaf —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç CartItemDto, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ 'selected' –∏–∑ –ë–î
    currentCartItems = /*[[${cartItemsPage.content}]]*/ [];

    // –†–µ–Ω–¥–µ—Ä–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
    renderCartItems(currentCartItems);
    updateSelectedSummary();
    updatePaginationControls(currentPage, totalPages); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
  });

  // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ ---
  async function handleItemSelectionChange(checkbox) {
    const productId = parseInt(checkbox.getAttribute('data-product-id'));
    const selected = checkbox.checked; // true if checked, false if unchecked

    try {
      const response = await fetch(`/api/v1/cart/update-selection?productId=${productId}&selected=${selected}`, {
        method: 'PUT',
        headers: getHeaders()
      });

      if (response.ok) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'selected' –≤ global currentCartItems
        const itemToUpdate = currentCartItems.find(item => item.productId === productId);
        if (itemToUpdate) {
          itemToUpdate.selected = selected;
        }
        updateSelectedSummary(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
        // showAlert('–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success'); // –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–ª—è –º–µ–Ω—å—à–µ–π –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç–∏
      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞: ${errorData.message || response.statusText}`, 'danger');
        // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
        checkbox.checked = !selected;
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞.', 'danger');
      console.error('Error updating item selection:', error);
      checkbox.checked = !selected; // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞
    }
  }

  // --- Select All Checkbox Logic ---
  async function toggleSelectAll(sourceCheckbox) {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const newSelectedState = sourceCheckbox.checked;

    const promises = [];
    checkboxes.forEach(checkbox => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ —Å—Ä–∞–∑—É
      checkbox.checked = newSelectedState;

      const productId = parseInt(checkbox.getAttribute('data-product-id'));
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
      promises.push(fetch(`/api/v1/cart/update-selection?productId=${productId}&selected=${newSelectedState}`, {
        method: 'PUT',
        headers: getHeaders()
      }).then(response => {
        if (!response.ok) {
          console.error(`Failed to update selection for product ${productId}`);
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º global currentCartItems –¥–ª—è —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        const itemToUpdate = currentCartItems.find(item => item.productId === productId);
        if (itemToUpdate) {
          itemToUpdate.selected = newSelectedState;
        }
      }).catch(error => {
        console.error(`Network error updating selection for product ${productId}:`, error);
      }));
    });

    // –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
    await Promise.allSettled(promises);
    updateSelectedSummary(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏ currentCartItems –æ–±–Ω–æ–≤–ª–µ–Ω—ã
  }

  // --- Update Selected Items Summary ---
  function updateSelectedSummary() {
    let totalSelectedQuantity = 0;
    let totalSelectedCost = 0;
    const allVisibleCheckboxes = document.querySelectorAll('.item-checkbox'); // –¢–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    allVisibleCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const productId = parseInt(checkbox.getAttribute('data-product-id'));
        // –ù–∞–π–¥–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä –≤ currentCartItems, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ `selected`
        const item = currentCartItems.find(i => i.productId === productId);
        if (item) {
          totalSelectedQuantity += item.quantity;
          totalSelectedCost += (item.quantity * item.productPrice);
        }
      }
    });

    document.getElementById('selected-total-quantity').textContent = totalSelectedQuantity;
    document.getElementById('selected-total-cost').textContent = formatDecimal(totalSelectedCost);

    const purchaseSelectedButton = document.getElementById('purchaseSelectedButton');
    if (totalSelectedQuantity > 0) {
      purchaseSelectedButton.classList.remove('disabled');
      purchaseSelectedButton.removeAttribute('disabled');
    } else {
      purchaseSelectedButton.classList.add('disabled');
      purchaseSelectedButton.setAttribute('disabled', 'true');
    }

    const selectAllCheckbox = document.getElementById('selectAllItemsCheckbox');
    if (selectAllCheckbox) {
      // "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–º–µ—á–µ–Ω, –µ—Å–ª–∏ –í–°–ï –≤–∏–¥–∏–º—ã–µ —á–µ–∫–±–æ–∫—Å—ã –æ—Ç–º–µ—á–µ–Ω—ã.
      // –ï—Å–ª–∏ allVisibleCheckboxes.length === 0, —Ç–æ selectAllCheckbox –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–Ω—è—Ç.
      selectAllCheckbox.checked = (allVisibleCheckboxes.length > 0 && Array.from(allVisibleCheckboxes).every(cb => cb.checked));
    }
  }


  // --- Start of updateCartItem function ---
  async function updateCartItem(event) {
    event.preventDefault();
    const form = event.target;
    const productId = parseInt(form.getAttribute('data-product-id'));
    const quantityInput = form.querySelector('input[name="quantity"]');
    const quantity = parseInt(quantityInput.value);
    const button = form.querySelector('button');
    const loading = form.querySelector('.loading');

    if (isNaN(quantity) || quantity < 0) {
      showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏ –Ω–µ –º–µ–Ω—å—à–µ 0.', 'danger');
      return;
    }

    button.disabled = true;
    loading.style.display = 'inline';

    try {
      const response = await fetch('/api/v1/cart/update-quantity', {
        method: 'PUT',
        headers: getHeaders(),
        body: JSON.stringify({
          productId: productId,
          quantity: quantity
        })
      });

      if (response.ok) {
        const updatedCartResponseDto = await response.json(); // –ü–æ–ª—É—á–∞–µ–º CartResponseDto

        showAlert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');

        // –û–±–Ω–æ–≤–ª—è–µ–º global currentCartItems –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CartResponseDto.cartItems
        currentCartItems = updatedCartResponseDto.cartItems; // –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º

        renderCartItems(currentCartItems);
        updateSelectedSummary();
        updateCartItemCount();
        updatePaginationControls(currentPage, totalPages); // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: ${errorData.message || response.statusText}`, 'danger');
        if (response.status === 401 || response.status === 403) {
          showAlert('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
          setTimeout(() => window.location.href = '/login', 2000);
        }
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.', 'danger');
      console.error('Error:', error);
    } finally {
      button.disabled = false;
      loading.style.display = 'none';
    }
  }
  // --- End of updateCartItem function ---

  // --- Start of removeCartItem function ---
  async function removeCartItem(event) {
    event.preventDefault();
    const form = event.target;
    const productId = parseInt(form.getAttribute('data-product-id'));
    const button = form.querySelector('button');
    const loading = form.querySelector('.loading');

    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
      return;
    }

    button.disabled = true;
    loading.style.display = 'inline';

    try {
      const response = await fetch(`/api/v1/cart/remove/${productId}`, {
        method: 'DELETE',
        headers: getHeaders()
      });

      if (response.ok) {
        const updatedCartResponseDto = await response.json(); // –ü–æ–ª—É—á–∞–µ–º CartResponseDto
        showAlert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã!', 'success');

        // –û–±–Ω–æ–≤–ª—è–µ–º global currentCartItems –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CartResponseDto.cartItems
        currentCartItems = updatedCartResponseDto.cartItems; // –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º

        renderCartItems(currentCartItems);
        updateSelectedSummary();
        updateCartItemCount();
        updatePaginationControls(currentPage, totalPages);
      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ${errorData.message || response.statusText}`, 'danger');
        if (response.status === 401 || response.status === 403) {
          showAlert('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
          setTimeout(() => window.location.href = '/login', 2000);
        }
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.', 'danger');
      console.error('Error:', error);
    } finally {
      button.disabled = false;
      loading.style.display = 'none';
    }
  }
  // --- End of removeCartItem function ---

  // --- Purchase Selected Items function ---
  async function purchaseSelectedItems() {
    const purchaseButton = document.getElementById('purchaseSelectedButton');
    // –ú—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º selectedProductIds, –ø–æ—Ç–æ–º—É —á—Ç–æ –±—ç–∫–µ–Ω–¥ –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ item.isSelected()
    // based on the DB state.
    // –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –±—ç–∫–µ–Ω–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, —Ç–æ currentCartItems.filter(item => item.selected)
    // –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å selectedCartItems –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
    // –ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –Ω–∞ UI –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏.
    const selectedCount = Array.from(document.querySelectorAll('.item-checkbox:checked')).length;

    if (selectedCount === 0) {
      showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏.', 'danger');
      return;
    }

    purchaseButton.disabled = true;
    purchaseButton.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏...';

    try {
      // –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å body, —Ç.–∫. –±—ç–∫–µ–Ω–¥ —Å–∞–º –±–µ—Ä–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
      const response = await fetch('/api/v1/cart/purchase', {
        method: 'POST', // POST, —Ç.–∫. —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
        headers: getHeaders()
      });

      if (response.ok) {
        const updatedCartResponseDto = await response.json();
        showAlert('–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω—ã! –ö–æ—Ä–∑–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.', 'success');

        // –û–±–Ω–æ–≤–ª—è–µ–º global currentCartItems –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
        currentCartItems = updatedCartResponseDto.cartItems; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ DTO

        renderCartItems(currentCartItems);
        updateSelectedSummary();
        updateCartItemCount();
        updatePaginationControls(currentPage, totalPages);
      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: ${errorData.message || response.statusText}`, 'danger');
        if (response.status === 401 || response.status === 403) {
          showAlert('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
          setTimeout(() => window.location.href = '/login', 2000);
        }
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏.', 'danger');
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
    } finally {
      purchaseButton.disabled = false;
      purchaseButton.textContent = '–ö—É–ø–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    }
  }

  // --- Helper function to render cart items (Centralized rendering) ---
  function renderCartItems(itemsToRender) {
    const tableBody = document.getElementById('cart-table-body');
    if (!tableBody) {
      console.error("–≠–ª–µ–º–µ–Ω—Ç 'cart-table-body' –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      return;
    }
    tableBody.innerHTML = '';

    const emptyMessage = document.getElementById('empty-cart-message');
    const actualCartTableWrapper = document.getElementById('actual-cart-table-wrapper');
    // paginationControls –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –∑–¥–µ—Å—å, –æ–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è updatePaginationControls

    if (itemsToRender && itemsToRender.length > 0) {
      itemsToRender.forEach(item => {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ item.selected —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        const isSelected = item.selected ? 'checked' : '';
        const row = `
          <tr id="cart-item-${item.productId}">
            <td>
              <input type="checkbox" class="item-checkbox" data-product-id="${item.productId}"
                     data-product-price="${item.productPrice}" data-quantity="${item.quantity}"
                     ${isSelected} onchange="handleItemSelectionChange(this)"/>
            </td>
            <td>${item.productName}</td>
            <td>
              ${item.productImage ? `<img src="${item.productImage}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="cart-item-image"/>` : `<span>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>`}
            </td>
            <td>${formatDecimal(item.productPrice)} MDL</td>
            <td>
              <form class="update-quantity-form" data-product-id="${item.productId}" onsubmit="updateCartItem(event)">
                <input type="number" name="quantity" value="${item.quantity}" min="0" class="form-control"/>
                <button type="submit" class="btn btn-warning btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <span class="loading spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </form>
            </td>
            <td class="item-total">${formatDecimal(item.itemTotal)} MDL</td>
            <td>
              <form class="remove-item-form" data-product-id="${item.productId}" onsubmit="removeCartItem(event)">
                <button type="submit" class="btn btn-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
                <span class="loading spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </form>
            </td>
          </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
      });
      if (emptyMessage) emptyMessage.style.display = 'none';
      if (actualCartTableWrapper) actualCartTableWrapper.style.display = 'block';
    } else {
      if (emptyMessage) emptyMessage.style.display = 'block';
      if (actualCartTableWrapper) actualCartTableWrapper.style.display = 'none';
    }
    updateSelectedSummary(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
  }


  // --- Cart Item Count in Header ---
  async function updateCartItemCount() {
    try {
      const response = await fetch('/api/v1/cart/summary', {
        method: 'GET',
        headers: getHeaders()
      });
      if (response.ok && response.headers.get("Content-Length") !== "0") {
        const cartSummary = await response.json();
        const cartCountSpan = document.getElementById('cartItemCount');
        if (cartCountSpan) {
          if (cartSummary.totalQuantity > 0) {
            cartCountSpan.textContent = cartSummary.totalQuantity;
            cartCountSpan.classList.remove('d-none');
          } else {
            cartCountSpan.classList.add('d-none');
          }
        }
      } else {
        const cartCountSpan = document.getElementById('cartItemCount');
        if (cartCountSpan) {
          cartCountSpan.textContent = '0';
          cartCountSpan.classList.add('d-none');
        }
        if (!response.ok) {
          console.error('Failed to fetch cart summary:', response.status, response.statusText);
        }
      }
    } catch (error) {
      console.error('Failed to update cart count:', error);
      const cartCountSpan = document.getElementById('cartItemCount');
      if (cartCountSpan) {
        cartCountSpan.textContent = '0';
        cartCountSpan.classList.add('d-none');
      }
    }
  }

  // --- Pagination Logic ---
  async function changePage(event, pageChange) {
    event.preventDefault();

    let newPage;
    if (typeof pageChange === 'number') { // -1 for previous, 1 for next, relative to current
      newPage = currentPage + pageChange;
    } else { // Specific page number clicked (text content)
      newPage = parseInt(pageChange); // Convert string to number
    }

    if (newPage < 0 || newPage >= totalPages) {
      return;
    }

    try {
      const response = await fetch(`/api/v1/cart/items?page=${newPage}&size=${pageSize}`, {
        method: 'GET',
        headers: getHeaders()
      });

      if (response.ok) {
        const pageData = await response.json();
        currentPage = pageData.number;
        totalPages = pageData.totalPages;

        // –í–∞–∂–Ω–æ: currentCartItems —Ç–µ–ø–µ—Ä—å –Ω–∞–ø—Ä—è–º—É—é –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –∏–∑ pageData.content
        // CartItemDto —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'selected' –∏–∑ –ë–î
        currentCartItems = pageData.content;

        renderCartItems(currentCartItems);
        updatePaginationControls(pageData.number, pageData.totalPages);

      } else {
        const errorData = await response.json().catch(() => ({ message: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${errorData.message || response.statusText}`, 'danger');
        if (response.status === 401 || response.status === 403) {
          showAlert('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'danger');
          setTimeout(() => window.location.href = '/login', 2000);
        }
      }
    } catch (error) {
      showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.', 'danger');
      console.error('Error:', error);
    }
  }

  function updatePaginationControls(currentPage, totalPages) {
    const paginationControls = document.getElementById('paginationControls');
    if (!paginationControls) return;

    paginationControls.innerHTML = '';

    if (totalPages <= 1) {
      paginationControls.style.display = 'none';
      return;
    } else {
      paginationControls.style.display = 'flex';
    }

    const prevClass = currentPage === 0 ? 'disabled' : '';
    paginationControls.insertAdjacentHTML('beforeend', `<li class="page-item ${prevClass}"><a class="page-link" href="#" onclick="changePage(event, -1)">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a></li>`);

    for (let i = 0; i < totalPages; i++) {
      const activeClass = i === currentPage ? 'active' : '';
      paginationControls.insertAdjacentHTML('beforeend', `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="changePage(event, ${i})">${i + 1}</a></li>`);
    }

    const nextClass = currentPage === totalPages - 1 ? 'disabled' : '';
    paginationControls.insertAdjacentHTML('beforeend', `<li class="page-item ${nextClass}"><a class="page-link" href="#" onclick="changePage(event, 1)">–°–ª–µ–¥—É—é—â–∞—è</a></li>`);
  }

  /*]]>*/
</script>
</body>
</html>